name: Gemma CI/CD

on:
  push:
    paths:
      - "gemma/**"
  pull_request:
    paths:
      - "gemma/**"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ---------------------------
      # Google Cloud Authentication
      # ---------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set Google Cloud Project
        run: gcloud config set project gemma-deployment

      # ---------------------------
      # Docker + Artifact Registry
      # ---------------------------
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker europe-central2-docker.pkg.dev --quiet

      # ---------------------------
      # Build & Push Docker Image
      # ---------------------------
      - name: Build and push Docker image
        run: |
          IMAGE="europe-central2-docker.pkg.dev/gemma-deployment/gemma-repo/gemma-deploy:${GITHUB_SHA}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

          docker build \
            --platform linux/amd64 \
            -t "$IMAGE" ./gemma

          docker push "$IMAGE"

      # ---------------------------
      # Deploy to Cloud Run (GPU)
      # ---------------------------
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy gemma-service \
            --image "$IMAGE" \
            --region europe-west4 \
            --platform managed \
            --service-account cloud-run-runtime-sa@gemma-deployment.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --cpu 4 \
            --memory 16Gi \
            --gpu 1 \
            --gpu-type nvidia-l4 \
            --timeout 600 \
            --min-instances 1 \
            --max-instances 10 \
            --concurrency 1
